apiVersion: {{ .apiVersion }}
kind: Deployment
{{ include "common.metadata" .metadata }}
spec:
  selector:
    matchLabels:
      {{- range .metadata.labels }}
      {{ .key }}: {{ .value }}
      {{- else }}
      {}
      {{- end }}
  replicas: {{ .spec.replicas.cnt }}
  strategy:
    type: {{ .spec.replicas.updateStrategy }}
    rollingUpdate:
      {{- if or .spec.replicas.maxUnavailable .spec.replicas.maxSurge }}
      {{- if .spec.replicas.maxUnavailable }}
      maxUnavailable: {{ .spec.replicas.maxUnavailable }}{{ if eq .spec.replicas.muaUnit "cnt" }}% {{ end }}
      {{- end }}
      {{- if .spec.replicas.maxSurge }}
      maxSurge: {{ .spec.replicas.maxSurge }}{{ if eq .spec.replicas.msUnit "cnt" }}% {{ end }}
      {{- end }}
      {{- else }}
      {}
      {{- end }}
  {{- if .spec.replicas.minReadySecs }}
  minReadySeconds: {{ .spec.replicas.minReadySecs }}
  {{- end }}
  {{- if .spec.replicas.progressDeadlineSecs }}
  progressDeadlineSeconds: {{ .spec.replicas.progressDeadlineSecs }}
  {{- end }}
  template:
    metadata:
      labels:
        {{- range .metadata.labels }}
        {{ .key }}: {{ .value }}
        {{- else }}
        {}
        {{- end }}
    spec:
      {{- include "container.containers" .containerGroup.containers | nindent 6 }}
      {{- include "container.initContainers" .containerGroup.initContainers | nindent 6 }}
      # affinity
      {{- if .spec.affinity }}
      affinity:
        {{- $podAffinity := filterTypeMapFromSlice .spec.affinity.podAffinity "type" "affinity" }}
        {{- if $podAffinity }}
        podAffinity:
          {{- if typeMapInSlice $podAffinity "priority" "required" }}
          requiredDuringSchedulingIgnoredDuringExecution:
            {{- range $podAffinity }}
            {{- if eq .priority "required" }}
            - namespaces:
              {{- range .namespaces }}
              - {{ . }}
              {{- else }}
              []
              {{- end }}
              topologyKey: {{ .topologyKey | quote }}
              labelSelector:
                matchExpressions:
                  {{- range .selector.expressions }}
                  - key: {{ .key | quote }}
                    operator: {{ .op }}
                    values:
                      {{- range $_, $item := splitList `,` .values }}
                      - {{ $item | quote }}
                      {{- else }}
                      []
                      {{- end }}
                  {{- else }}
                  []
                  {{- end }}
                matchLabels:
                  {{- range .selector.labels }}
                  {{ .key | quote }}: {{ .value | quote }}
                  {{- else }}
                  {}
                  {{- end }}
            {{- end }}
            {{- end }}
          {{- end }}
          {{- if typeMapInSlice $podAffinity "priority" "preferred" }}
          preferredDuringSchedulingIgnoredDuringExecution:
            {{- range $podAffinity }}
            {{- if eq .priority "preferred" }}
            - weight: {{ .weight }}
              podAffinityTerm:
                namespaces:
                  {{- range .namespaces }}
                  - {{ . }}
                  {{- else }}
                  []
                  {{- end }}
                topologyKey: {{ .topologyKey | quote }}
                labelSelector:
                  matchExpressions:
                    {{- range .selector.expressions }}
                    - key: {{ .key | quote }}
                      operator: {{ .op }}
                      values:
                        {{- range $_, $item := splitList `,` .values }}
                        - {{ $item | quote }}
                        {{- else }}
                        []
                        {{- end }}
                    {{- else }}
                    []
                    {{- end }}
                  matchLabels:
                      {{- range .selector.labels }}
                      {{ .key | quote }}: {{ .value | quote }}
                      {{- else }}
                      {}
                      {{- end }}
            {{- end }}
            {{- end }}
          {{- end }}
        {{- end }}
        {{- $podAntiAffinity := filterTypeMapFromSlice .spec.affinity.podAffinity "type" "antiAffinity" }}
        {{- if $podAntiAffinity }}
        podAntiAffinity:
          {{- if typeMapInSlice $podAntiAffinity "priority" "required" }}
          requiredDuringSchedulingIgnoredDuringExecution:
            {{- range $podAntiAffinity }}
            {{- if eq .priority "required" }}
            - namespaces:
              {{- range .namespaces }}
              - {{ . }}
              {{- else }}
              []
              {{- end }}
              topologyKey: {{ .topologyKey | quote }}
              labelSelector:
                matchExpressions:
                  {{- range .selector.expressions }}
                  - key: {{ .key | quote }}
                    operator: {{ .op }}
                    values:
                      {{- range $_, $item := splitList `,` .values }}
                      - {{ $item | quote }}
                      {{- else }}
                      []
                      {{- end }}
                  {{- else }}
                  []
                  {{- end }}
                matchLabels:
                  {{- range .selector.labels }}
                  {{ .key | quote }}: {{ .value | quote }}
                  {{- else }}
                  {}
                  {{- end }}
            {{- end }}
            {{- end }}
          {{- end }}
          {{- if typeMapInSlice $podAffinity "priority" "preferred" }}
          preferredDuringSchedulingIgnoredDuringExecution:
            {{- range $podAntiAffinity }}
            {{- if eq .priority "preferred" }}
            - weight: {{ .weight }}
              podAffinityTerm:
                namespaces:
                  {{- range .namespaces }}
                  - {{ . }}
                  {{- else }}
                  []
                  {{- end }}
                topologyKey: {{ .topologyKey | quote }}
                labelSelector:
                  matchExpressions:
                    {{- range .selector.expressions }}
                    - key: {{ .key | quote }}
                      operator: {{ .op }}
                      values:
                        {{- range $_, $item := splitList `,` .values }}
                        - {{ $item | quote }}
                        {{- else }}
                        []
                        {{- end }}
                    {{- else }}
                    []
                    {{- end }}
                  matchLabels:
                    {{- range .selector.labels }}
                    {{ .key | quote }}: {{ .value | quote }}
                    {{- else }}
                    {}
                    {{- end }}
              {{- end }}
              {{- end }}
          {{- end }}
        {{- end }}
        {{- if .spec.affinity.nodeAffinity }}
        nodeAffinity:
          {{- if typeMapInSlice .spec.affinity.nodeAffinity "priority" "required" }}
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              {{- range .spec.affinity.nodeAffinity }}
              {{- if eq .priority "required" }}
              - matchExpressions:
                {{- range .selector.expressions }}
                - key: {{ .key | quote }}
                  operator: {{ .op }}
                  values:
                    {{- range $_, $item := splitList `,` .values }}
                    - {{ $item | quote }}
                    {{- else }}
                    []
                    {{- end }}
                {{- else }}
                {}
                {{- end }}
                matchFields:
                {{- range .selector.fields }}
                - key: {{ .key | quote }}
                  operator: {{ .op }}
                  values:
                    {{- range $_, $item := splitList `,` .values }}
                    - {{ $item | quote }}
                    {{- else }}
                    []
                    {{- end }}
                {{- else }}
                {}
                {{- end }}
              {{- end }}
              {{- end }}
          {{- end }}
          {{- if typeMapInSlice .spec.affinity.nodeAffinity "priority" "preferred" }}
          preferredDuringSchedulingIgnoredDuringExecution:
            {{- range .spec.affinity.nodeAffinity }}
              {{- if eq .priority "preferred" }}
              - weight: {{ .weight }}
                preference:
                  matchExpressions:
                  {{- range .selector.expressions }}
                  - key: {{ .key | quote }}
                    operator: {{ .op }}
                    values:
                      {{- range $_, $item := splitList `,` .values }}
                      - {{ $item | quote }}
                      {{- else }}
                      []
                      {{- end }}
                  {{- else }}
                  {}
                  {{- end }}
                  matchFields:
                  {{- range .selector.fields }}
                  - key: {{ .key | quote }}
                    operator: {{ .op }}
                    values:
                      {{- range $_, $item := splitList `,` .values }}
                      - {{ $item | quote }}
                      {{- else }}
                      []
                      {{- end }}
                  {{- else }}
                  {}
                  {{- end }}
              {{- end }}
            {{- end }}
          {{- end }}
        {{- end }}
      {{- end }}
      # toleration
      tolerations:
        {{- range .spec.toleration.rules }}
        - key: {{ .key | quote }}
          operator: {{ .op }}
          effect: {{ .effect }}
          {{- if .value }}
          value: {{ .value | quote }}
          {{- end }}
          {{- if .tolerationSecs }}
          tolerationSeconds: {{ .tolerationSecs }}
          {{- end }}
        {{- else }}
        []
        {{- end }}
      # nodeSelect
      {{- if eq .spec.nodeSelect.type "specificNode" }}
      nodeName: {{ .spec.nodeSelect.nodeName }}
      {{- else if eq .spec.nodeSelect.type "schedulingRule" }}
      nodeSelector:
        {{- range .spec.nodeSelect.selector }}
        {{ .key }}: {{ .value }}
        {{- else }}
        {}
        {{- end }}
      {{- end }}
      # networking
      dnsPolicy: {{ .spec.networking.dnsPolicy }}
      {{- if .spec.networking.hostIPC }}
      hostIPC: {{ .spec.networking.hostIPC }}
      {{- end }}
      {{- if .spec.networking.hostNetwork }}
      hostNetwork: {{ .spec.networking.hostNetwork }}
      {{- end }}
      {{- if .spec.networking.hostPID }}
      hostPID: {{ .spec.networking.hostPID }}
      {{- end }}
      {{- if .spec.networking.shareProcessNamespace }}
      shareProcessNamespace: {{ .spec.networking.shareProcessNamespace }}
      {{- end }}
      {{- if .spec.networking.hostname }}
      hostname: {{ .spec.networking.hostname }}
      {{- end }}
      {{- if .spec.networking.subdomain }}
      subdomain: {{ .spec.networking.subdomain }}
      {{- end }}
      dnsConfig:
        nameservers:
          {{- range .spec.networking.nameServers }}
          - {{ . | quote }}
          {{- else }}
          []
          {{- end }}
        searches:
          {{- range .spec.networking.searches }}
          - {{ . | quote }}
          {{- else }}
          []
          {{- end }}
        options:
          {{- range .spec.networking.dnsResolverOpts }}
          - name: {{ .name | quote }}
            value: {{ .value | quote }}
          {{- else }}
          []
          {{- end }}
      hostAliases:
        {{- range .spec.networking.hostAliases }}
        - ip: {{ .ip | quote }}
          hostnames:
            {{- range $idx, $item := splitList "," .alias }}
            - {{ $item | quote }}
            {{- else }}
            []
            {{- end }}
        {{- end }}
      # security
      {{- if .spec.security }}
      securityContext:
        {{- if .spec.security.runAsUser }}
        runAsUser: {{ .spec.security.runAsUser }}
        {{- end }}
        runAsNonRoot: {{ .spec.security.runAsNonRoot }}
        {{- if .spec.security.runAsGroup }}
        runAsGroup: {{ .spec.security.runAsGroup }}
        {{- end }}
        {{- if .spec.security.fsGroup }}
        fsGroup: {{ .spec.security.fsGroup }}
        {{- end }}
        seLinuxOptions:
          {{- range $k, $v := .spec.security.seLinuxOpt }}
          {{ $k | quote }}: {{ $v | quote }}
          {{- else }}
          {}
          {{- end }}
      {{- end }}
      # other
      {{- if .spec.other.restartPolicy }}
      restartPolicy: {{ .spec.other.restartPolicy }}
      {{- end }}
      {{- if .spec.other.terminationGracePeriodSecs }}
      terminationGracePeriodSeconds: {{ .spec.other.terminationGracePeriodSecs }}
      {{- end }}
      imagePullSecrets:
        {{- range .spec.other.imagePullSecrets }}
        - name: {{ . | quote }}
        {{- else }}
        []
        {{- end }}
      {{- if .spec.other.saName }}
      serviceAccountName: {{ .spec.other.saName }}
      {{- end }}
      volumes:
        {{- range .volume.pvc }}
        - name: {{ .name }}
          persistentVolumeClaim:
            claimName: {{ .pvcName }}
            {{- if .readOnly }}
            readOnly: {{ .readOnly }}
            {{- end }}
        {{- end }}
        {{- range .volume.hostPath }}
        - name: {{ .name }}
          hostPath:
            path: {{ .path | quote }}
            type: {{ .type }}
        {{- end }}
        {{- range .volume.configMap }}
        - name: {{ .name }}
          configMap:
            defaultMode: {{ .defaultMode }}
            name: {{ .cmName }}
            {{- if .items }}
            items:
              {{- range .items }}
              - key: {{ .key | quote }}
                path: {{ .path | quote }}
              {{- end }}
            {{- end }}
        {{- end }}
        {{- range .volume.secret }}
        - name: {{ .name }}
          secret:
            defaultMode: {{ .defaultMode }}
            secretName: {{ .secretName }}
            {{- if .items }}
            items:
              {{- range .items }}
              - key: {{ .key | quote }}
                path: {{ .path | quote }}
              {{- end }}
            {{- end }}
        {{- end }}
        {{- range .volume.emptyDir }}
        - name: {{ .name }}
          emptyDir: {}
        {{- end }}
        {{- range .volume.nfs }}
        - name: {{ .name }}
          nfs:
            path: {{ .path | quote }}
            server: {{ .server | quote }}
            {{- if .readOnly }}
            readOnly: {{ .readOnly }}
            {{- end }}
        {{- end }}
