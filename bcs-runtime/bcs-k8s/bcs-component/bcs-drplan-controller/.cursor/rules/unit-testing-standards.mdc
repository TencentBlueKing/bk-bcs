---
description: å•å…ƒæµ‹è¯•è§„èŒƒ - Ginkgo/Gomega å’Œæµ‹è¯•æœ€ä½³å®è·µ
alwaysApply: true
---

# å•å…ƒæµ‹è¯•è§„èŒƒ

æœ¬é¡¹ç›®ä½¿ç”¨ **Ginkgo v2 + Gomega** æµ‹è¯•æ¡†æ¶ï¼Œéµå¾ª BDDï¼ˆè¡Œä¸ºé©±åŠ¨å¼€å‘ï¼‰é£æ ¼ã€‚

---

## ğŸ“ æµ‹è¯•æ–‡ä»¶ç»„ç»‡

### æ–‡ä»¶å‘½å

```
åŠŸèƒ½ä»£ç :         drplan_controller.go
å•å…ƒæµ‹è¯•:         drplan_controller_test.go
æµ‹è¯•å¥—ä»¶ï¼ˆå¯é€‰ï¼‰: suite_test.go
```

### åŒ…ç»“æ„

```go
package controller // ä¸è¢«æµ‹è¯•ä»£ç åŒåŒ…

import (
    . "github.com/onsi/ginkgo/v2"      // BDD æµ‹è¯•æ¡†æ¶
    . "github.com/onsi/gomega"          // æ–­è¨€åº“
    "sigs.k8s.io/controller-runtime/pkg/envtest"  // K8s æµ‹è¯•ç¯å¢ƒ
)
```

---

## ğŸ¯ æµ‹è¯•ç»“æ„

### BDD é£æ ¼å±‚æ¬¡

```go
var _ = Describe("DRPlan Controller", func() {          // ğŸ“¦ æµ‹è¯•å¥—ä»¶
    Context("When reconciling a resource", func() {      // ğŸ“‚ æµ‹è¯•ä¸Šä¸‹æ–‡
        It("should successfully reconcile", func() {     // âœ… æµ‹è¯•ç”¨ä¾‹
            // æµ‹è¯•å®ç°
        })
    })
})
```

**å±‚æ¬¡è¯´æ˜**:
- `Describe`: æè¿°è¢«æµ‹è¯•çš„ç»„ä»¶/åŠŸèƒ½ï¼ˆ1 ä¸ªæ–‡ä»¶ 1 ä¸ª Describeï¼‰
- `Context`: æè¿°ç‰¹å®šåœºæ™¯/æ¡ä»¶ï¼ˆå¯åµŒå¥—ï¼‰
- `It`: å…·ä½“çš„æµ‹è¯•ç”¨ä¾‹ï¼ˆåº”è¯¥ç®€æ´ã€ç‹¬ç«‹ï¼‰

---

## âœ… æµ‹è¯•ç”¨ä¾‹ç¼–å†™

### Good Practicesï¼ˆæ¨èï¼‰

#### 1. ä½¿ç”¨æ¸…æ™°çš„æµ‹è¯•æè¿°

```go
// âœ… GOOD - æè¿°æœŸæœ›è¡Œä¸º
It("should update plan phase to Executed after successful execution", func() {
    // ...
})

It("should reject concurrent executions for the same plan", func() {
    // ...
})

// âŒ BAD - æ¨¡ç³Šã€ä¸æ¸…æ¥šæœŸæœ›
It("should work correctly", func() {
    // ...
})

It("test plan", func() {
    // ...
})
```

#### 2. ä½¿ç”¨ By() æ­¥éª¤æè¿°

```go
It("should execute a plan successfully", func() {
    By("creating the DRPlan resource")
    plan := &drv1alpha1.DRPlan{...}
    Expect(k8sClient.Create(ctx, plan)).To(Succeed())
    
    By("waiting for plan to become Ready")
    Eventually(func() string {
        _ = k8sClient.Get(ctx, client.ObjectKeyFromObject(plan), plan)
        return plan.Status.Phase
    }).Should(Equal(drv1alpha1.PlanPhaseReady))  // âœ… ä½¿ç”¨å¸¸é‡
    
    By("creating an execution")
    execution := &drv1alpha1.DRPlanExecution{...}
    Expect(k8sClient.Create(ctx, execution)).To(Succeed())
})
```

#### 3. ä½¿ç”¨å¸¸é‡è€Œéå­—ç¬¦ä¸²å­—é¢é‡

```go
// âœ… GOOD - ä½¿ç”¨ api/v1alpha1/constants.go ä¸­çš„å¸¸é‡
Expect(plan.Status.Phase).To(Equal(drv1alpha1.PlanPhaseReady))
Expect(execution.Status.Phase).To(Equal(drv1alpha1.PhaseSucceeded))

// âŒ BAD - å­—ç¬¦ä¸²å­—é¢é‡
Expect(plan.Status.Phase).To(Equal("Ready"))
Expect(execution.Status.Phase).To(Equal("Succeeded"))
```

#### 4. ä½¿ç”¨ Eventually å¤„ç†å¼‚æ­¥æ“ä½œ

```go
// âœ… GOOD - ä½¿ç”¨ Eventually ç­‰å¾…å¼‚æ­¥ç»“æœ
Eventually(func() string {
    _ = k8sClient.Get(ctx, key, &resource)
    return resource.Status.Phase
}, 1*time.Minute, 1*time.Second).Should(Equal(drv1alpha1.PhaseSucceeded))

// âŒ BAD - ç›´æ¥æ£€æŸ¥ï¼ˆå¯èƒ½å¤±è´¥ï¼‰
Expect(resource.Status.Phase).To(Equal(drv1alpha1.PhaseSucceeded))
```

**Eventually å‚æ•°**:
```go
Eventually(
    func() Type { /* æ£€æŸ¥å‡½æ•° */ },
    timeout,     // æœ€é•¿ç­‰å¾…æ—¶é—´ï¼ˆå¦‚ 1*time.Minuteï¼‰
    interval,    // æ£€æŸ¥é—´éš”ï¼ˆå¦‚ 100*time.Millisecondï¼‰
).Should(matcher)
```

#### 5. æ­£ç¡®ä½¿ç”¨ Gomega æ–­è¨€

```go
// âœ… GOOD - è¯­ä¹‰æ¸…æ™°çš„æ–­è¨€
Expect(err).NotTo(HaveOccurred())           // æ— é”™è¯¯
Expect(list.Items).To(HaveLen(3))           // é•¿åº¦æ£€æŸ¥
Expect(output).To(ContainSubstring("foo"))  // åŒ…å«æ£€æŸ¥
Expect(resource).NotTo(BeNil())             // éç©ºæ£€æŸ¥

// âŒ BAD - ä½¿ç”¨ == æˆ–å¸ƒå°”æ¯”è¾ƒ
Expect(err == nil).To(BeTrue())
Expect(len(list.Items) == 3).To(BeTrue())
```

**å¸¸ç”¨ Matchers**:
- `Equal(x)` - ç›¸ç­‰
- `BeNil()` - ä¸º nil
- `HaveLen(n)` - é•¿åº¦ä¸º n
- `ContainSubstring(s)` - åŒ…å«å­ä¸²
- `BeEmpty()` - ä¸ºç©º
- `HaveOccurred()` - æœ‰é”™è¯¯å‘ç”Ÿ

---

## ğŸ”§ æµ‹è¯•è®¾ç½®å’Œæ¸…ç†

### BeforeEach / AfterEach

```go
var _ = Describe("DRPlan Controller", func() {
    var (
        ctx        context.Context
        testPlan   *drv1alpha1.DRPlan
        planName   string
    )
    
    BeforeEach(func() {
        ctx = context.Background()
        planName = "test-plan-" + time.Now().Format("20060102150405")
        
        By("creating dependencies (e.g., DRWorkflow)")
        workflow := &drv1alpha1.DRWorkflow{...}
        Expect(k8sClient.Create(ctx, workflow)).To(Succeed())
        
        By("creating the test resource")
        testPlan = &drv1alpha1.DRPlan{
            ObjectMeta: metav1.ObjectMeta{
                Name:      planName,
                Namespace: "default",
            },
            Spec: drv1alpha1.DRPlanSpec{...},
        }
        Expect(k8sClient.Create(ctx, testPlan)).To(Succeed())
    })
    
    AfterEach(func() {
        By("cleaning up test resources")
        if testPlan != nil {
            _ = k8sClient.Delete(ctx, testPlan)
        }
        
        By("cleaning up dependencies")
        workflow := &drv1alpha1.DRWorkflow{}
        _ = k8sClient.Get(ctx, client.ObjectKey{Name: "test-workflow", Namespace: "default"}, workflow)
        if workflow.Name != "" {
            _ = k8sClient.Delete(ctx, workflow)
        }
    })
    
    It("should reconcile successfully", func() {
        // æµ‹è¯•é€»è¾‘ä½¿ç”¨ testPlan
    })
})
```

**æ³¨æ„äº‹é¡¹**:
- âœ… åœ¨ `BeforeEach` ä¸­åˆ›å»ºæµ‹è¯•æ‰€éœ€èµ„æº
- âœ… åœ¨ `AfterEach` ä¸­æ¸…ç†èµ„æºï¼ˆå³ä½¿æµ‹è¯•å¤±è´¥ï¼‰
- âœ… ä½¿ç”¨å”¯ä¸€çš„èµ„æºåç§°ï¼ˆæ·»åŠ æ—¶é—´æˆ³æˆ–éšæœºåç¼€ï¼‰
- âŒ ä¸è¦åœ¨ `AfterEach` ä¸­ä½¿ç”¨ `Expect` æ£€æŸ¥åˆ é™¤ç»“æœï¼ˆä½¿ç”¨ `_` å¿½ç•¥é”™è¯¯ï¼‰

---

## ğŸ­ æµ‹è¯•éš”ç¦»

### ç‹¬ç«‹çš„æµ‹è¯•ç”¨ä¾‹

```go
// âœ… GOOD - æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹åˆ›å»ºèµ„æº
Context("When creating a plan", func() {
    It("should validate required fields", func() {
        invalidPlan := &drv1alpha1.DRPlan{
            Spec: drv1alpha1.DRPlanSpec{
                Stages: []drv1alpha1.Stage{},  // ç©º stages
            },
        }
        err := k8sClient.Create(ctx, invalidPlan)
        Expect(err).To(HaveOccurred())
    })
    
    It("should accept valid plan", func() {
        validPlan := &drv1alpha1.DRPlan{
            Spec: drv1alpha1.DRPlanSpec{
                Stages: []drv1alpha1.Stage{
                    {Name: "stage-1", Workflows: [...]},
                },
            },
        }
        Expect(k8sClient.Create(ctx, validPlan)).To(Succeed())
    })
})

// âŒ BAD - æµ‹è¯•ä¹‹é—´æœ‰ä¾èµ–
It("should create plan", func() {
    plan := &drv1alpha1.DRPlan{...}
    Expect(k8sClient.Create(ctx, plan)).To(Succeed())
    sharedPlan = plan  // âŒ å…±äº«çŠ¶æ€
})

It("should update the plan", func() {
    sharedPlan.Spec.Description = "Updated"  // âŒ ä¾èµ–ä¸Šä¸€ä¸ªæµ‹è¯•
    Expect(k8sClient.Update(ctx, sharedPlan)).To(Succeed())
})
```

---

## ğŸ§ª Controller æµ‹è¯•ï¼ˆä½¿ç”¨ envtestï¼‰

### æµ‹è¯•å¥—ä»¶è®¾ç½®ï¼ˆsuite_test.goï¼‰

```go
var (
    ctx       context.Context
    cancel    context.CancelFunc
    testEnv   *envtest.Environment
    cfg       *rest.Config
    k8sClient client.Client
)

func TestControllers(t *testing.T) {
    RegisterFailHandler(Fail)
    RunSpecs(t, "Controller Suite")
}

var _ = BeforeSuite(func() {
    logf.SetLogger(zap.New(zap.WriteTo(GinkgoWriter), zap.UseDevMode(true)))
    
    ctx, cancel = context.WithCancel(context.TODO())
    
    By("bootstrapping test environment")
    testEnv = &envtest.Environment{
        CRDDirectoryPaths:     []string{filepath.Join("..", "..", "config", "crd", "bases")},
        ErrorIfCRDPathMissing: true,
    }
    
    var err error
    cfg, err = testEnv.Start()
    Expect(err).NotTo(HaveOccurred())
    Expect(cfg).NotTo(BeNil())
    
    // æ³¨å†Œ CRD schemes
    err = drv1alpha1.AddToScheme(scheme.Scheme)
    Expect(err).NotTo(HaveOccurred())
    
    k8sClient, err = client.New(cfg, client.Options{Scheme: scheme.Scheme})
    Expect(err).NotTo(HaveOccurred())
    Expect(k8sClient).NotTo(BeNil())
})

var _ = AfterSuite(func() {
    cancel()
    By("tearing down the test environment")
    err := testEnv.Stop()
    Expect(err).NotTo(HaveOccurred())
})
```

---

## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

| å±‚çº§ | ç›®æ ‡è¦†ç›–ç‡ | è¯´æ˜ |
|------|-----------|------|
| **Controller** | 60%+ | Reconcile æ ¸å¿ƒé€»è¾‘ |
| **Executor** | 70%+ | Execute/Rollback æ–¹æ³• |
| **Webhook** | 80%+ | éªŒè¯é€»è¾‘ |
| **Util/Helper** | 50%+ | å·¥å…·å‡½æ•° |

**è¿è¡Œè¦†ç›–ç‡æ£€æŸ¥**:
```bash
make test  # è‡ªåŠ¨ç”Ÿæˆ cover.out
go tool cover -html=cover.out -o coverage.html
```

---

## ğŸš« é¿å…çš„åæ¨¡å¼

### 1. æµ‹è¯•å®ç°ç»†èŠ‚è€Œéè¡Œä¸º

```go
// âŒ BAD - æµ‹è¯•å†…éƒ¨å®ç°
It("should call reconcileStages 3 times", func() {
    // ä¸åº”è¯¥æµ‹è¯•å†…éƒ¨å‡½æ•°è°ƒç”¨æ¬¡æ•°
})

// âœ… GOOD - æµ‹è¯•å¤–éƒ¨å¯è§‚å¯Ÿè¡Œä¸º
It("should update status after reconciling all stages", func() {
    // éªŒè¯æœ€ç»ˆçŠ¶æ€
    Expect(plan.Status.Phase).To(Equal(drv1alpha1.PlanPhaseReady))
})
```

### 2. è¿‡åº¦ä¾èµ– mock

```go
// âŒ BAD - è¿‡åº¦ mockï¼ˆenvtest å·²æä¾›çœŸå® K8s APIï¼‰
mockClient := &MockClient{}
mockClient.On("Get", ...).Return(nil)
mockClient.On("Update", ...).Return(nil)

// âœ… GOOD - ä½¿ç”¨ envtest æä¾›çš„çœŸå®å®¢æˆ·ç«¯
plan := &drv1alpha1.DRPlan{...}
Expect(k8sClient.Create(ctx, plan)).To(Succeed())
```

### 3. æµ‹è¯•è¿‡é•¿ã€èŒè´£ä¸æ¸…

```go
// âŒ BAD - ä¸€ä¸ªæµ‹è¯•åšå¤ªå¤šäº‹æƒ…
It("should handle entire lifecycle", func() {
    // åˆ›å»º plan
    // æ‰§è¡Œ execute
    // éªŒè¯ç»“æœ
    // æ‰§è¡Œ revert
    // éªŒè¯æ¸…ç†
    // ... 100+ è¡Œä»£ç 
})

// âœ… GOOD - æ‹†åˆ†æˆå¤šä¸ªç‹¬ç«‹æµ‹è¯•
It("should execute plan successfully", func() { ... })
It("should revert plan successfully", func() { ... })
It("should clean up resources after revert", func() { ... })
```

---

## ğŸ“ æµ‹è¯•å‘½åçº¦å®š

### æµ‹è¯•æ–‡ä»¶

```
åŠŸèƒ½æ¨¡å—: internal/controller/drplan_controller.go
æµ‹è¯•æ–‡ä»¶: internal/controller/drplan_controller_test.go
```

### æµ‹è¯•å˜é‡

```go
var _ = Describe("DRPlan Controller", func() {
    var (
        // ä½¿ç”¨æ¸…æ™°çš„å˜é‡å
        ctx          context.Context
        testPlan     *drv1alpha1.DRPlan
        testWorkflow *drv1alpha1.DRWorkflow
        reconciler   *DRPlanReconciler
        
        // é¿å…å•å­—æ¯å˜é‡ï¼ˆé™¤äº†å¾ªç¯ï¼‰
        // âŒ p, w, r
    )
})
```

---

## ğŸ¯ æµ‹è¯•ç¼–å†™æ£€æŸ¥æ¸…å•

ç¼–å†™æµ‹è¯•æ—¶ï¼Œç¡®ä¿ï¼š

- [ ] æµ‹è¯•æè¿°æ¸…æ™°ï¼ˆæè¿°æœŸæœ›è¡Œä¸ºï¼Œnot å®ç°ï¼‰
- [ ] ä½¿ç”¨ `By()` åˆ†æ­¥éª¤æè¿°æµ‹è¯•æµç¨‹
- [ ] ä½¿ç”¨å¸¸é‡è€Œéå­—ç¬¦ä¸²å­—é¢é‡
- [ ] å¼‚æ­¥æ“ä½œä½¿ç”¨ `Eventually`
- [ ] åœ¨ `BeforeEach` ä¸­è®¾ç½®æµ‹è¯•ç¯å¢ƒ
- [ ] åœ¨ `AfterEach` ä¸­æ¸…ç†èµ„æº
- [ ] æµ‹è¯•ä¹‹é—´å®Œå…¨ç‹¬ç«‹ï¼ˆæ— å…±äº«çŠ¶æ€ï¼‰
- [ ] æµ‹è¯•å¤–éƒ¨è¡Œä¸ºè€Œéå†…éƒ¨å®ç°
- [ ] æ¯ä¸ªæµ‹è¯•ä¸“æ³¨ä¸€ä¸ªåœºæ™¯
- [ ] ä½¿ç”¨è¯­ä¹‰åŒ–çš„ Gomega æ–­è¨€

---

## ğŸ“š ç›¸å…³èµ„æº

- [Ginkgo æ–‡æ¡£](https://onsi.github.io/ginkgo/)
- [Gomega æ–­è¨€æŒ‡å—](https://onsi.github.io/gomega/)
- [Controller-Runtime Testing](https://book.kubebuilder.io/reference/testing)
- [Envtest ä½¿ç”¨æŒ‡å—](https://pkg.go.dev/sigs.k8s.io/controller-runtime/pkg/envtest)

---

## ğŸ” ç¤ºä¾‹ï¼šå®Œæ•´çš„æµ‹è¯•æ–‡ä»¶

```go
package controller

import (
    . "github.com/onsi/ginkgo/v2"
    . "github.com/onsi/gomega"
    
    drv1alpha1 "github.com/Tencent/bk-bcs/.../api/v1alpha1"
)

var _ = Describe("DRPlan Controller", func() {
    Context("When reconciling a valid plan", func() {
        var (
            ctx      context.Context
            testPlan *drv1alpha1.DRPlan
        )
        
        BeforeEach(func() {
            ctx = context.Background()
            
            By("creating prerequisites")
            // ... åˆ›å»ºä¾èµ–èµ„æº
            
            By("creating test plan")
            testPlan = &drv1alpha1.DRPlan{...}
            Expect(k8sClient.Create(ctx, testPlan)).To(Succeed())
        })
        
        AfterEach(func() {
            By("cleaning up")
            _ = k8sClient.Delete(ctx, testPlan)
        })
        
        It("should set phase to Ready", func() {
            Eventually(func() string {
                _ = k8sClient.Get(ctx, client.ObjectKeyFromObject(testPlan), testPlan)
                return testPlan.Status.Phase
            }, "1m", "1s").Should(Equal(drv1alpha1.PlanPhaseReady))
        })
        
        It("should validate all stages", func() {
            Eventually(func() []metav1.Condition {
                _ = k8sClient.Get(ctx, client.ObjectKeyFromObject(testPlan), testPlan)
                return testPlan.Status.Conditions
            }).Should(ContainElement(
                MatchFields(IgnoreExtras, Fields{
                    "Type":   Equal("Ready"),
                    "Status": Equal(metav1.ConditionTrue),
                }),
            ))
        })
    })
})
```

**è®°ä½**: å¥½çš„æµ‹è¯•æ˜¯é¡¹ç›®è´¨é‡çš„ä¿è¯ï¼Œå€¼å¾—æŠ•å…¥æ—¶é—´ç¼–å†™ï¼
