---
description: 使用常量而非字符串字面量设置状态值（Phase、OperationType 等）
globs: **/*.go
alwaysApply: false
---

# 状态常量使用规范

## 规则

所有状态字段（Phase、OperationType、FailurePolicy 等）**必须使用常量**，不允许使用字符串字面量。

## 为什么需要常量？

1. **避免拼写错误**: `"Succeded"` vs `"Succeeded"` 编译器无法检测
2. **类型安全**: 常量提供编译时检查
3. **IDE 支持**: 自动补全、重构、查找引用
4. **维护性**: 统一修改，避免遗漏

---

## 常量定义位置

**建议**: 在 `api/v1alpha1/constants.go` 中定义所有状态常量

```go
package v1alpha1

// Execution/Action/Workflow/Stage Phase constants
const (
    PhasePending   = "Pending"
    PhaseRunning   = "Running"
    PhaseSucceeded = "Succeeded"
    PhaseFailed    = "Failed"
    PhaseSkipped   = "Skipped"
    PhaseCancelled = "Cancelled"
    PhaseUnknown   = "Unknown"
)

// DRPlan Phase constants
const (
    PlanPhaseReady    = "Ready"
    PlanPhaseExecuted = "Executed"
    PlanPhaseInvalid  = "Invalid"
)

// Operation Type constants
const (
    OperationTypeExecute = "Execute"
    OperationTypeRevert  = "Revert"
)

// Failure Policy constants
const (
    FailurePolicyStop     = "Stop"
    FailurePolicyContinue = "Continue"
    FailurePolicyFailFast = "FailFast"
)

// Action Type constants
const (
    ActionTypeHTTP               = "HTTP"
    ActionTypeJob                = "Job"
    ActionTypeLocalization       = "Localization"
    ActionTypeSubscription       = "Subscription"
    ActionTypeKubernetesResource = "KubernetesResource"
)

// Resource Operation constants
const (
    OperationCreate = "Create"
    OperationApply  = "Apply"
    OperationPatch  = "Patch"
    OperationDelete = "Delete"
)
```

---

## ❌ 错误示例

```go
// 直接使用字符串字面量
status.Phase = "Succeeded"
status.Phase = "Failed"
status.Phase = "Running"

if status.Phase == "Succeeded" {
    // ...
}

execution.Spec.OperationType = "Execute"
action.Type = "Localization"
```

**问题**:
- 容易拼写错误（如 `"Succeded"`, `"Runing"`）
- 编译器无法检测错误
- 难以全局修改
- 无法使用 IDE 的重构功能

---

## ✅ 正确示例

```go
// 使用导入的常量
import drv1alpha1 "github.com/.../api/v1alpha1"

// 设置状态
status.Phase = drv1alpha1.PhaseSucceeded
status.Phase = drv1alpha1.PhaseFailed
status.Phase = drv1alpha1.PhaseRunning

// 比较状态
if status.Phase == drv1alpha1.PhaseSucceeded {
    // ...
}

// 设置操作类型
execution.Spec.OperationType = drv1alpha1.OperationTypeExecute
action.Type = drv1alpha1.ActionTypeLocalization

// 设置失败策略
plan.Spec.FailurePolicy = drv1alpha1.FailurePolicyStop
```

**优点**:
- ✅ 编译时类型检查
- ✅ IDE 自动补全
- ✅ 重构安全
- ✅ 统一管理

---

## 在内部包中使用

对于 `internal/` 下的代码，建议直接导入常量：

```go
package executor

import (
    drv1alpha1 "github.com/Tencent/bk-bcs/.../api/v1alpha1"
)

func (e *Executor) execute() {
    // ✅ 使用常量
    rollbackStatus := &drv1alpha1.ActionStatus{
        Name:      actionStatus.Name,
        Phase:     drv1alpha1.PhaseRunning,  // 正确
        StartTime: &metav1.Time{Time: time.Now()},
    }
    
    if err != nil {
        rollbackStatus.Phase = drv1alpha1.PhaseFailed  // 正确
        rollbackStatus.Message = fmt.Sprintf("Failed: %v", err)
        return rollbackStatus, err
    }
    
    rollbackStatus.Phase = drv1alpha1.PhaseSucceeded  // 正确
    return rollbackStatus, nil
}
```

---

## 常见场景

### 1. 初始化状态结构

```go
// ❌ 错误
status := &drv1alpha1.ActionStatus{
    Phase: "Running",
}

// ✅ 正确
status := &drv1alpha1.ActionStatus{
    Phase: drv1alpha1.PhaseRunning,
}
```

### 2. 更新状态

```go
// ❌ 错误
execution.Status.Phase = "Succeeded"
stageStatus.Phase = "Failed"

// ✅ 正确
execution.Status.Phase = drv1alpha1.PhaseSucceeded
stageStatus.Phase = drv1alpha1.PhaseFailed
```

### 3. 条件判断

```go
// ❌ 错误
if actionStatus.Phase != "Succeeded" {
    continue
}
if workflowStatus.Phase == "Failed" {
    return err
}

// ✅ 正确
if actionStatus.Phase != drv1alpha1.PhaseSucceeded {
    continue
}
if workflowStatus.Phase == drv1alpha1.PhaseFailed {
    return err
}
```

### 4. Switch 语句

```go
// ❌ 错误
switch execution.Spec.OperationType {
case "Execute":
    return e.ExecutePlan(ctx, plan, execution)
case "Revert":
    return e.RevertPlan(ctx, plan, execution)
}

// ✅ 正确
switch execution.Spec.OperationType {
case drv1alpha1.OperationTypeExecute:
    return e.ExecutePlan(ctx, plan, execution)
case drv1alpha1.OperationTypeRevert:
    return e.RevertPlan(ctx, plan, execution)
}
```

---

## 检查现有代码

使用 `grep` 查找需要修复的字符串字面量：

```bash
# 查找 Phase 字符串字面量
grep -r 'Phase.*=.*"Succeeded"' internal/
grep -r 'Phase.*=.*"Failed"' internal/
grep -r 'Phase.*=.*"Running"' internal/

# 查找条件判断中的字符串字面量
grep -r 'Phase.*==.*"Succeeded"' internal/
grep -r 'Phase.*!=.*"Succeeded"' internal/
```

---

## 迁移步骤

1. **创建常量文件**: `api/v1alpha1/constants.go`
2. **定义所有常量**: Phase、OperationType、FailurePolicy 等
3. **批量替换**: 使用 IDE 的查找替换功能
4. **测试验证**: 运行单元测试和集成测试
5. **Code Review**: 确保没有遗漏

---

## 总结

| 场景 | 错误写法 | 正确写法 |
|------|---------|---------|
| 设置状态 | `status.Phase = "Succeeded"` | `status.Phase = drv1alpha1.PhaseSucceeded` |
| 判断状态 | `if phase == "Failed"` | `if phase == drv1alpha1.PhaseFailed` |
| 操作类型 | `operationType = "Execute"` | `operationType = drv1alpha1.OperationTypeExecute` |
| 动作类型 | `action.Type = "Job"` | `action.Type = drv1alpha1.ActionTypeJob` |

**记住**: 永远不要使用字符串字面量设置状态值！
