K8S_GEN_VERSION := v1.20.1
# Image generated by https://github.com/slok/kube-code-generator
IMAGE := quay.io/slok/kube-code-generator:$(K8S_GEN_VERSION)

DIRECTORY := $(PWD)
PROJECT_PACKAGE := github.com/Tencent/bk-bcs/bcs-runtime/bcs-k8s/bcs-component/bcs-gamedeployment-operator
DEPS_CMD := go mod tidy

.PHONY: generate
generate: generate-client generate-crd

.PHONY: generate-client
generate-client:
	docker run -it --rm \
	-v $(DIRECTORY):/go/src/$(PROJECT_PACKAGE) \
	-v $(DIRECTORY)/hack/boilerplate.go.txt:/go/src/k8s.io/code-generator/hack/boilerplate.go.txt \
	-e PROJECT_PACKAGE=$(PROJECT_PACKAGE) \
	-e CLIENT_GENERATOR_OUT=$(PROJECT_PACKAGE)/pkg/client \
	-e APIS_ROOT=$(PROJECT_PACKAGE)/pkg/apis \
	-e GROUPS_VERSION="tkex:v1alpha1" \
	-e GENERATION_TARGETS="client,informer,lister" \
	$(IMAGE)

.PHONY: generate-crd
generate-crd:
	docker run -it --rm \
	-v $(DIRECTORY):/src \
	-e GO_PROJECT_ROOT=/src \
	-e CRD_TYPES_PATH=/src/apis \
	-e CRD_OUT_PATH=/src/manifests \
	$(IMAGE) update-crd.sh

.PHONY: deps
deps:
	$(DEPS_CMD)

.PHONY: clean
clean:
	echo "Cleaning generated files..."
	rm -rf ./pkg/client
	rm -rf ./pkg/apis/tkex/v1alpha1/zz_generated.deepcopy.go